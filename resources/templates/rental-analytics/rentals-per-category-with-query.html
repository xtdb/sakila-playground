{% with rentals_category="
        WITH rental_categories AS 
            (SELECT film_category.category_id as category_id,
                    count(*) as films_rented 
            FROM rental
            LEFT JOIN inventory ON rental.inventory_id = inventory.xt$id
            LEFT JOIN film_category ON inventory.film_id = film_category.film_id
            GROUP BY film_category.category_id)
        SELECT category.name AS category_name,
            rental_categories.category_id, 
            rental_categories.films_rented 
        FROM rental_categories 
        LEFT JOIN category ON rental_categories.category_id = category.xt$id
        ORDER BY category.name ASC
" %}
<table>
    <caption>Rentals per category</caption>
    <thead>
        <tr>
            <th>Category</th>
            <th>Rented</th>
        </tr>
    </thead>
    <tbody>
        {% for rental in rentals_category|query %}
        <tr>
            <td>{{ rental.category_name }}</td>
            <td>{{ rental.films_rented }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endwith %}